# Puzzleboss Docker Setup

This directory contains Docker configuration for running Puzzleboss in a local development environment.

## Quick Start

```bash
# Build and start all services
docker-compose up --build

# Or run in background
docker-compose up -d --build
```

Access the application:
- **Web UI**: http://localhost
- **API/Swagger**: http://localhost:5000/apidocs
- **MySQL**: localhost:3306 (user: puzzleboss, pass: puzzleboss123)

## Default Test Account

The setup automatically creates a test user with admin privileges:
- **Username**: `testuser`
- **Full Name**: Test User
- **Privileges**: puzztech and puzzleboss admin

The PHP frontend is configured in test mode, so you can access it using:
http://localhost?assumedid=testuser

## Architecture

### Single App Container
- **Apache** (port 80) - Serves PHP frontend from `/app/www`
- **Gunicorn** (port 5000) - Python Flask API
- **BigJimmy Bot** - Disabled by default (requires Google API setup)

Apache proxies `/api/*`, `/apidocs`, and `/metrics` to the Python backend.

### MySQL Container
- **Version**: MySQL 8.4.7
- Automatically initializes with schema from `scripts/puzzleboss.sql`
- Data persists in Docker volume `mysql_data`
- **SSL/TLS**: Enabled by default with auto-generated certificates
  - Certificates are generated by MySQL on first startup
  - Copied to shared volume `mysql_certs` for app container access
  - Uses `caching_sha2_password` authentication (secure with SSL)

**Note**: If upgrading from MySQL 8.0 or if SSL certificates are missing, run:
```bash
docker-compose down -v && docker-compose up --build
```
This recreates volumes and regenerates SSL certificates.

## Configuration

**No configuration needed!** The Docker image includes `puzzleboss.yaml` with Docker-ready defaults.

The default config is pre-configured for Docker with:
- MySQL host set to `mysql` (Docker service name)
- MySQL SSL/TLS enabled with auto-generated certificates
- Test credentials (username: puzzleboss, password: puzzleboss123)
- All optional integrations disabled (Google, Discord)
- Test mode enabled for PHP authentication

**To customize configuration:**
1. Create your own `puzzleboss.yaml` in the project root
2. Uncomment the volume mount in `docker-compose.yml`:
   ```yaml
   - ./puzzleboss.yaml:/app/puzzleboss.yaml
   ```
3. Rebuild: `docker-compose up --build`

For production deployment, create `puzzleboss.yaml` from the sample and change:
- `MYSQL.HOST` from "mysql" to your MySQL server (e.g., `127.0.0.1` or RDS endpoint)
- `MYSQL.PASSWORD` to a secure password
- `MYSQL.SSL.CA` to your production CA certificate path (see SSL section below)

## MySQL SSL/TLS Configuration

### Default Docker Setup (Auto-generated Certificates)

SSL is **enabled by default** in the Docker setup:
- MySQL 8.4.7 automatically generates self-signed SSL certificates on first startup
- The `setup-mysql-ssl.sh` script copies certificates to the shared volume
- App container reads certificates from `/var/lib/mysql-certs/ca.pem`
- All connections between app and MySQL are encrypted

**No action required** - SSL works out of the box!

### Disabling SSL (Not Recommended)

To disable SSL for testing:
1. Edit `puzzleboss.yaml` and comment out the `SSL:` section:
   ```yaml
   MYSQL:
       USERNAME: puzzleboss
       PASSWORD: puzzleboss123
       HOST: mysql
       PORT: 3306
       DATABASE: puzzleboss
       # SSL:
       #     CA: /var/lib/mysql-certs/ca.pem
   ```
2. Restart: `docker-compose restart app`

### AWS RDS SSL Setup

When connecting to AWS RDS:
1. Download the RDS CA bundle:
   ```bash
   mkdir -p /etc/ssl/certs
   curl -o /etc/ssl/certs/rds-ca-bundle.pem https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem
   ```
2. Update `puzzleboss.yaml`:
   ```yaml
   MYSQL:
       HOST: your-instance.xyz.us-east-1.rds.amazonaws.com
       SSL:
           CA: /etc/ssl/certs/rds-ca-bundle.pem
   ```
3. Mount the certificate in `docker-compose.yml`:
   ```yaml
   volumes:
     - /etc/ssl/certs/rds-ca-bundle.pem:/etc/ssl/certs/rds-ca-bundle.pem:ro
   ```

### Verifying SSL Connection

Check if SSL is active:
```bash
docker exec puzzleboss-app python3 -c "
from pblib import config
import MySQLdb
conn = MySQLdb.connect(
    host=config['MYSQL']['HOST'],
    user=config['MYSQL']['USERNAME'],
    passwd=config['MYSQL']['PASSWORD'],
    db=config['MYSQL']['DATABASE'],
    ssl={'ca': config['MYSQL']['SSL']['CA']} if 'SSL' in config['MYSQL'] else None
)
cursor = conn.cursor()
cursor.execute('SHOW STATUS LIKE \"Ssl_cipher\"')
print(cursor.fetchone())
conn.close()
"
```

If SSL is working, you'll see a cipher name (e.g., `TLS_AES_256_GCM_SHA384`). If SSL is disabled, the value will be empty.

## Development Workflow

Code changes are live-reloaded via volume mounts:
- `www/` - PHP frontend
- `*.py` - Python backend
- `scripts/` - Scripts and schema
- `swag/` - API documentation

To reload Python after code changes:
```bash
docker-compose restart app
```

## UI Testing with Playwright

The Docker image includes Playwright for headless browser testing. This is useful for:
- Debugging frontend issues without manual browser testing
- Integration tests that verify both API and UI behavior
- Automated testing in CI/CD pipelines

### Running UI Tests

```bash
# Run the example UI tests
docker exec puzzleboss-app python3 scripts/test_ui_playwright.py
```

### Writing Custom Tests

Example test script:
```python
from playwright.sync_api import sync_playwright

with sync_playwright() as p:
    browser = p.chromium.launch(headless=True)
    page = browser.new_page()
    page.goto('http://localhost?assumedid=testuser')

    # Enable console logging
    page.on("console", lambda msg: print(f"Browser: {msg.text()}"))

    # Interact with the page
    page.click('button:has-text("Show advanced controls")')
    page.wait_for_selector('text=Show puzzles:')

    # Take screenshot on errors
    page.screenshot(path='/tmp/test_error.png')

    browser.close()
```

### Available Tests

See `scripts/test_ui_playwright.py` for examples:
- Basic page load test
- Advanced controls rendering
- Puzzle creation flow

**Note**: Playwright is installed with Chromium only to minimize image size. For Firefox/WebKit support, modify the Dockerfile to install additional browsers.

## Stopping and Cleaning Up

```bash
# Stop services
docker-compose down

# Remove volumes (deletes database data)
docker-compose down -v

# Rebuild after changes
docker-compose up --build
```

## Enabling Optional Features

### BigJimmy Bot (Google Sheets Integration)
1. Get Google API credentials and place in project root
2. Update `puzzleboss-docker.yaml`:
   - Set config variable `SKIP_GOOGLE_API: false`
3. Edit `docker/supervisord.conf`:
   - Set `autostart=true` for `[program:bigjimmybot]`
4. Rebuild: `docker-compose up --build`

### Discord Integration
1. Set up puzzcord daemon separately
2. Update database config table with `SKIP_PUZZCORD=false` and connection details

## Troubleshooting

### Database Connection Errors
```bash
# Check MySQL is running
docker-compose ps

# View MySQL logs
docker-compose logs mysql

# Manually connect to database
docker exec -it puzzleboss-mysql mysql -u puzzleboss -ppuzzleboss123 puzzleboss
```

### API Not Starting
```bash
# View Gunicorn logs
docker-compose logs app

# Check if port 5000 is available
docker exec -it puzzleboss-app netstat -tlnp | grep 5000
```

### Permission Errors
```bash
# Reset file permissions (if needed)
chmod +x docker/docker-entrypoint.sh
```

### SSL Certificate Errors

If you see `TLS/SSL error: No such file or directory`:
```bash
# Recreate volumes to regenerate SSL certificates
docker-compose down -v
docker-compose up --build
```

If upgrading from an older version without SSL:
```bash
# Stop containers
docker-compose down

# Remove only the mysql_certs volume (keeps your data)
docker volume rm puzzleboss2_mysql_certs

# Restart - certs will be regenerated
docker-compose up
```

## Production Notes

This Docker setup is optimized for local development. For production:
- Remove volume mounts in `docker-compose.yml`
- Use proper secrets management (not plaintext passwords)
- Configure Apache REMOTE_USER authentication
- Enable HTTPS/TLS
- Set up proper logging and monitoring
- Use production WSGI server configuration
