# Redirect insecure HTTP connections to canonical HTTPS site
<VirtualHost *:80>
    ServerName importanthuntpoll.org
    ServerAlias  www.importanthuntpoll.org

    DocumentRoot "/canadia"

    # server status has to be here in http for munin to work
    <Location "/server-status">
        SetHandler server-status
        Order deny,allow
        Deny from all
        Allow from 127.0.0.1 ::1
        Allow from 146.115.38.0/24
        Allow from 192.0.0.0/8
    </Location>

    <Location /server-info>
        SetHandler server-info
	Order deny,allow
	Deny from all
        Allow from 73.143.210.125
    </Location>

    <Location "/favico.ico">
        AllowOverride None
        Order Deny,Allow
        Deny from none
        Allow from all
        Satisfy Any
    </Location>


    ServerAdmin bigjimmy@stormynight.org

    ErrorLog ${APACHE_LOG_DIR}/error.log
    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel info
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # protect operating system disk root
    <Directory "/canadia">
        AllowOverride All
        Options FollowSymLinks
        Order Deny,Allow
        Deny from all
	Allow from none
    </Directory>

    <Location "/robots.txt">
        AllowOverride None
        Order Deny,Allow
        Deny from none
        Allow from all
        Satisfy Any
    </Location>


    <Directory "/canadia/.well-known">
        AllowOverride None
        Order Allow,deny
        Allow from all
        Deny from none
        Satisfy Any
    </Directory>

    <Location "/favicon.ico">
        AllowOverride None
        Order Deny,Allow
        Deny from none
        Allow from all
        Satisfy Any
    </Location>

    RedirectMatch 301 ^/$ https://importanthuntpoll.org

</VirtualHost>

<IfModule mod_ssl.c>
    # https redirects to canonicalize hostname
    <VirtualHost *:443>
        ServerName www.importanthuntpoll.org
        ServerAlias *.stormynight.org
        ServerAdmin benoc@alum.mit.edu
        ErrorLog ${APACHE_LOG_DIR}/error.log
        LogLevel warn
        CustomLog ${APACHE_LOG_DIR}/access.log combined
        RedirectMatch 301 ^/(.*)$ https://importanthuntpoll.org/$1
        SSLEngine on
        SSLCertificateFile   /etc/letsencrypt/live/importanthuntpoll.org/cert.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/importanthuntpoll.org/privkey.pem
        SSLCertificateChainFile    /etc/letsencrypt/live/importanthuntpoll.org/chain.pem
    </VirtualHost>

    # actual https server
    <VirtualHost *:443>
        # servername must match certificates
        ServerName importanthuntpoll.org
        ServerAdmin benoc@alum.mit.edu
        ServerAlias localhost
        ErrorLog ${APACHE_LOG_DIR}/error.log
        LogLevel info
        AddType text/html .wl
        DocumentRoot /canadia

        ######################################################################
        # Google OIDC authentication (replaces mod_auth_memcookie + SimpleSAMLphp)
        ######################################################################
        OIDCProviderMetadataURL https://accounts.google.com/.well-known/openid-configuration
        # Secrets loaded from separate file (not in git)
        Include /canadia/puzzleboss2/oidc-secrets.conf
        OIDCRedirectURI         https://importanthuntpoll.org/oauth2callback
        OIDCScope               "openid email profile"
        OIDCSessionInactivityTimeout 288000
        OIDCCookieLifespan       288000
        OIDCCacheType            memcache
        OIDCMemCacheServers      "series-of-tubes-internal.importanthuntpoll.org:11211"
        # Extract bare username from email (e.g. "benoc" from "benoc@domain.com")
        OIDCRemoteUserClaim     email "(.+)@.+" "$1"
        # Restrict login to team Google Workspace domain only
        OIDCAuthRequestParams   hd=importanthuntpoll.org&access_type=online&approval_prompt=auto

        # OIDC callback endpoint (mod_auth_openidc handles this automatically)
        <Location /oauth2callback>
            Order Allow,Deny
            Allow from all
            AuthType openid-connect
            Require valid-user
        </Location>

        <Location /server-info>
            SetHandler server-info
	    Order deny,allow
            Require ip 73.143.210.125
        </Location>

        # protect operating system disk root
        <Directory "/">
            AllowOverride None
            Options FollowSymLinks
            Order Deny,Allow
            Deny from all
        </Directory>

        <Location "/robots.txt">
            AllowOverride None
            Order Deny,Allow
            Deny from none
            Allow from all
            Satisfy Any
        </Location>

        <Location "/favicon.ico">
            AllowOverride None
            Order Deny,Allow
            Deny from none
            Allow from all
            Satisfy Any
        </Location>

        <Location "/server-status">
            SetHandler server-status
            Order deny,allow
            Deny from all
            Allow from all
            Allow from 127.0.0.1 ::1
            Allow from 146.115.38.0/24
            Allow from 192.0.0.0/8
            Satisfy Any
        </Location>

        RewriteEngine on

        LogLevel info
        CustomLog ${APACHE_LOG_DIR}/the-internet-ssl_access.log combined
        SSLEngine on
        SSLCertificateFile   /etc/letsencrypt/live/importanthuntpoll.org/cert.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/importanthuntpoll.org/privkey.pem
        SSLCertificateChainFile    /etc/letsencrypt/live/importanthuntpoll.org/chain.pem
        <FilesMatch "\.(cgi|shtml|phtml|php)$">
            SSLOptions +StdEnvVars
        </FilesMatch>

        BrowserMatch "MSIE [2-6]" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0
        # MSIE 7 and newer should be able to use keepalive
        BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

        ######################################################################
        # Redirects and proxies
        ######################################################################

        Redirect /discordinvite  https://discord.gg/vhzHTsUDm6
        Redirect /discord https://discord.gg/vhzHTsUDm6

        Redirect /apidocs /apidocs/
        ProxyPass "/apidocs/" "http://localhost:5000/apidocs/"
        ProxyPassReverse "/apidocs/" "http://localhost:5000/apidocs/"
        #RewriteLog "/var/log/apache2/rewritelog.log"
        RewriteRule ^/wiki$ /wiki/ [R,L]
        RewriteRule ^/$ /wiki/ [R,L]
        RewriteRule ^/puzzleboss(.*) /puzzleboss$1
        Redirect /flasgger_static /flasgger_static/
        ProxyPass "/flasgger_static/" "http://localhost:5000/flasgger_static/"
        ProxyPassReverse "/flasgger_static/" "http://localhost:5000/flasgger_static/"
        ProxyPass "/apispec_1.json" "http://localhost:5000/apispec_1.json"
        ProxyPassReverse "/apispec_1.json" "http://localhost:5000/apispec_1.json"
        Redirect /register /account
        Redirect /metrics /metrics/
        ProxyPreserveHost On
        ProxyPass "/metrics/" "http://localhost:3000/"
        ProxyPassReverse "/metrics/" "http://localhost:3000/"

        ######################################################################
        # user registration (auth handled by PHP session gate)
        ######################################################################
        Alias /account /canadia/puzzleboss2/account
        <Directory "/canadia/puzzleboss2/account">
            AllowOverride None
            order allow,deny
            allow from all
            Options +ExecCGI
            DirectoryIndex index.php
            AuthType None
            Require all granted
        </Directory>

        ######################################################
        # info page
        ######################################################
        Alias /info /var/www/html
        <Directory "/var/www/html">
            AllowOverride None
            order allow,deny
            allow from all
            DirectoryIndex index.html
            AuthType None
            Require all granted
        </Directory>

        ##################################################
        # mediawiki
        ##################################################
        Alias /wiki /var/www/mediawiki-current
        <Directory /var/www/mediawiki-current>
            Options -Indexes +FollowSymLinks +MultiViews
            order allow,deny
            allow from all
	    deny from 46.229.168.0/24

            # Completely bypass auth module for localhost
            <If "%{REMOTE_ADDR} == '127.0.0.1'">
                AuthType None
                Require all granted
                SetEnv REMOTE_USER bigjimmy
            </If>
            <Else>
                AuthType openid-connect
                Require valid-user
            </Else>
        </Directory>

        # some mediawiki directories must be protected
        <Directory /var/www/mediawiki-current/config>
            Options -FollowSymLinks
            AllowOverride None
            php_admin_flag engine off
        </Directory>
        <Directory /var/www/mediawiki-current/images>
            Options -FollowSymLinks
            AllowOverride None
            php_admin_flag engine off
        </Directory>
        <Directory /var/www/mediawiki-current/upload>
            Options -FollowSymLinks
            AllowOverride None
            php_admin_flag engine off
        </Directory>

        #################################################
        # wind-up-birds solving scripts
        #################################################
        Alias /scripts /var/www/scripts
        <Directory "/var/www/scripts">
            Options Indexes FollowSymLinks MultiViews ExecCGI
            AllowOverride None
            Order Allow,Deny
            Allow from all

            AddHandler cgi-script .cgi

            AuthType openid-connect
            Require valid-user
        </Directory>

        #################################################
        # grafana
        #################################################
        <Location /metrics>
            order allow,deny
            allow from all
            deny from 46.229.168.0/24

            AuthType openid-connect
            Require valid-user
        </Location>


        #################################################
        # puzzleboss 2000
        #################################################
        Alias /pb /canadia/puzzleboss2/www
        <Directory "/canadia/puzzleboss2/www">
	    Options FollowSymLinks MultiViews ExecCGI
            AllowOverride None

            Order Deny,Allow

            # comment for non-auth testing from specific source ip
            Allow from all
            ###################

            # uncomment for non-auth testing from specific source ip
            #Deny from all
            #Allow from 71.233.151.229
            #Satisfy Any
            ###################

            # Completely bypass auth module for localhost
            <If "%{REMOTE_ADDR} == '127.0.0.1'">
                AuthType None
                Require all granted
                SetEnv REMOTE_USER benoc
            </If>

            AddHandler cgi-script .cgi

            AuthType openid-connect
            Require valid-user
        </Directory>

        <Location ~ "metrics.php">
            Satisfy Any
            Allow from all
            AuthType None
            Require all granted
        </Location>

        #################################################
        # New puzzleboss swagger
        #################################################
        <Location /apidocs>
            order allow,deny
            allow from all
            deny from 46.229.168.0/24

            AuthType openid-connect
            Require valid-user
        </Location>

        <Location /swaggerui>
            order allow,deny
            allow from all
            deny from 46.229.168.0/24

            AuthType openid-connect
            Require valid-user
        </Location>

        <Location /swagger.json>
            order allow,deny
            allow from all
            deny from 46.229.168.0/24

            AuthType openid-connect
            Require valid-user
        </Location>



        #################################################
        # wind-up-birds skills survey
        #################################################
        Alias /sktsurvey /var/www/sktsurvey
        <Directory "/var/www/sktsurvey">
            Options FollowSymLinks MultiViews ExecCGI
            AllowOverride None
            Order Allow,Deny
            Allow from all

            AddHandler cgi-script .cgi

            AuthType openid-connect
            Require valid-user
        </Directory>

        #################################################
        # wind-up-birds legacy mailing list archives
        #################################################
        Alias /mailmanarchives /var/www/mailmanarchives
        <Directory "/var/www/mailmanarchives">
            Options Indexes FollowSymLinks MultiViews
            AllowOverride None
            Order Allow,Deny
            Allow from all

            AuthType openid-connect
            Require valid-user
        </Directory>

        <Location "/robots.txt">
            AllowOverride None
            Order Deny,Allow
            Deny from none
            Allow from all
            Satisfy Any
        </Location>

        <Directory "/canadia/core">
            AllowOverride None
            Satisfy Any
            Order Allow,Deny
            Allow from all
            AuthType None
        </Directory>

	##############################
	# phpMyAdmin
	##############################
	Alias /phpmyadmin /usr/share/phpmyadmin

	<Directory /usr/share/phpmyadmin>
    	    Options SymLinksIfOwnerMatch
            DirectoryIndex index.php
            Order Allow,Deny
            Allow from all

            AuthType openid-connect
            Require valid-user

            <IfModule mod_php8.c>
            <IfModule mod_mime.c>
                AddType application/x-httpd-php .php
            </IfModule>
            <FilesMatch ".+\.php$">
                SetHandler application/x-httpd-php
            </FilesMatch>

            php_value include_path .
            php_admin_value upload_tmp_dir /var/lib/phpmyadmin/tmp
            php_admin_value open_basedir /usr/share/phpmyadmin/:/usr/share/doc/phpmyadmin/:/etc/phpmyadmin/:/var/lib/phpmyadmin/:/usr/share/php/:/usr/share/javascript/
            php_admin_value mbstring.func_overload 0
            </IfModule>

        </Directory>

	# Disallow web access to directories that don't need it
	<Directory /usr/share/phpmyadmin/templates>
    	    Require all denied
	</Directory>
	<Directory /usr/share/phpmyadmin/libraries>
    	    Require all denied
	</Directory>
	<Directory /usr/share/phpmyadmin/setup/lib>
    	    Require all denied
	</Directory>

    </VirtualHost>

</IfModule>
